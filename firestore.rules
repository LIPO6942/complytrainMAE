
/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model
 * with two primary roles: 'admin' and 'user'. Admins have broad read access for
 * oversight, while regular users are strictly confined to their own data,
 * ensuring strong privacy and data ownership.
 *
 * Data Structure: User-specific data is stored under `/users/{userId}`. Global
 * data, such as departments and courses, is located in top-level collections.
 * Administrator status is efficiently managed by a `role` field within each
 * user's document.
 *
 * Key Security Decisions:
 * - Admin access is granted by reading the `role` field from the user's own
 *   document. This is a common pattern for RBAC.
 * - Users can only read and modify their own `/users/{userId}` document. Listing
 *   other users is forbidden to protect Personally Identifiable Information (PII).
 * - Global data collections like `/departments` and `/courses` are read-only for
 *   all signed-in users. Writes are restricted to admins, indicating that this
 *   data should be managed by a trusted role.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the foundation for the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if the user is a designated administrator by checking the 'role'
     * field in their own user document.
     */
    function isAdmin() {
      // Use exists() to avoid errors on new user creation when their doc doesn't exist yet.
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Users can create, read, and write to their own profile. Admins can read any profile.
     * @path        /users/{userId}
     */
    match /users/{userId} {
      allow create, write, update: if request.auth != null && request.auth.uid == userId;
      allow read: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Allows any signed-in user to read department information. Writes are disabled from the client.
     * @path        /departments/{departmentId}
     * @allow       (get) Any signed-in user gets a department document.
     * @deny        (create) Any user is denied from creating a new department.
     * @principle   Treats this collection as read-only data for clients. Writes must be managed by a trusted backend.
     */
    match /departments/{departmentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    /**
     * @description Stores all available compliance courses. Readable by all signed-in users, but only writable by admins.
     * @path        /courses/{courseId}
     * @allow       (list, get) Any signed-in user can view the list of available courses.
     * @allow       (create, update, delete) Only admins can add, modify, or remove courses.
     * @principle   Enforces a clear separation of content consumption (all users) and content management (admins).
     */
    match /courses/{courseId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();

      /**
       * @description Stores quiz data for a specific course. Readable by all signed-in users, but only writable by admins.
       * @path        /courses/{courseId}/quizzes/{quizId}
       * @allow       (list, get) Any signed-in user can view the quiz for a course.
       * @allow       (create, update, delete) Only admins can manage quizzes.
       * @principle   Nested data inherits the parent's read/write restrictions but can be further restricted.
       */
      match /quizzes/{quizId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
      }
    }

    /**
     * @description Stores user invitations. Only admins can create/read them. Completed invitations can be updated.
     * @path /invitations/{invitationId}
     * @allow (read, create): if isAdmin();
     * @allow (update): if isAdmin(); 
     * @allow (delete): if false;
     * @principle Only admins can manage user invitations.
     */
    match /invitations/{invitationId} {
        allow read, create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if false;
    }
  }
}
